/*!
 * maptalks.odline v0.1.0
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],e):e(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,e){"use strict";function o(t,e){for(var o=Object.getOwnPropertyNames(e),i=0;i<o.length;i++){var n=o[i],r=Object.getOwnPropertyDescriptor(e,n);r&&r.configurable&&void 0===t[n]&&Object.defineProperty(t,n,r)}return t}function i(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function r(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):o(t,e))}function a(t,e,o,i){var n=1-i;return n*(n*t+2*i*e)+i*i*o}var s={animation:!0,random:!1,duration:6e3,curveness:.2,trail:20,globalCompositeOperation:"lighter"},p=function(t){function o(e,r,a){i(this,o),r&&!Array.isArray(r)&&(r=[r]);var s=n(this,t.call(this,e,a));return s.setData(r),s}return r(o,t),o.prototype.getData=function(){return this._data},o.prototype.setData=function(t){return this._data=t,this.getMap()&&(this._prepareData(),this._getRenderer()&&this._getRenderer().render()),this},o.prototype.identify=function(){},o.prototype.getParticles=function(t){this._animStartTime||(this._animStartTime=Date.now());for(var o,i,n,r,s,p,u,h=this.getMap(),d=h.getScale(),l=(t-this._animStartTime)%this.options.duration/this.options.duration,c=[],f={},y=0,_=this._dataToDraw.length;y<_;y++)this.options.random&&(l=(t-this._animStartTime-this._dataToDraw[y].time)%this.options.duration/this.options.duration,l<0&&(l=0)),l>0&&(o=this._dataToDraw[y].points,r=this._data[y].symbol||f,s=o[0],p=o[1],o[2]?(u=o[2],i=a(s.x,u.x,p.x,l),n=a(s.y,u.y,p.y,l)):(i=s.x+l*(p.x-s.x),n=s.y+l*(p.y-s.y)),c.push({point:h._pointToContainerPoint(new e.Point(i,n)._multi(1/d)),r:(r.lineWidth||3)/2,color:r.lineColor}));return c},o.prototype.draw=function(e){return this._dataToDraw||this._prepareData(),this.options.animation?t.prototype.draw.apply(this,arguments):(this._drawLines(e),this)},o.prototype.onConfig=function(){this._getRenderer()&&this._getRenderer().render()},o.prototype.onRemove=function(){delete this._dataToDraw},o.prototype.toJSON=function(t){t||(t={});var o={type:this.getJSONType(),id:this.getId(),options:this.config()},i=this.getData();if(t.clipExtent){for(var n=new e.Extent(t.clipExtent),r=[],a=0,s=i.length;a<s;a++)n.contains(new e.Coordinate(i[a][0],i[a][1]))&&r.push(i[a]);o.data=r}else o.data=i;return o},o.fromJSON=function(t){return t&&t.type===this.getJSONType()?new o(t.id,t.data,t.options):null},o.prototype._precise=function(t){return e.Util.round(100*t)/100},o.prototype._drawLines=function(t){if(this._dataToDraw){var e,o,i,n,r,a=this.getMap(),s=a.getScale(),p={},u=this.options.symbol||p;t.lineCap="round";for(var h=0,d=this._dataToDraw.length;h<d;h++)e=this._dataToDraw[h].points,o=this._data[h].symbol||p,t.strokeStyle=o.lineColor||u.lineColor||"rgba(255, 255, 255, 0.01)",t.lineWidth=o.lineWidth||u.lineWidth||1,t.beginPath(),i=a._pointToContainerPoint(e[0].multi(1/s)),t.moveTo(i.x,i.y),n=a._pointToContainerPoint(e[1].multi(1/s)),e[2]?(r=a._pointToContainerPoint(e[2].multi(1/s)),t.quadraticCurveTo(r.x,r.y,n.x,n.y)):t.lineTo(n.x,n.y),t.stroke()}},o.prototype._prepareData=function(){if(this._data){for(var t,o,i=this.options.curveness,n=this.getMap(),r=n.getMaxZoom(),a=[],s=0,p=this._data.length;s<p;s++){t=n.coordinateToPoint(new e.Coordinate(this._data[s].coordinates[0]),r),o=n.coordinateToPoint(new e.Coordinate(this._data[s].coordinates[1]),r);var u=[t,o];if(i){var h=o.distanceTo(t),d=t.substract(o)._unit()._perp(),l=t.add(o)._multi(.5),c=i*h,f=new e.Point(l.x+c*d.x,l.y+c*d.y);u.push(f)}a.push({points:u,time:Math.random()*this.options.duration})}this._dataToDraw=a}},o}(e.ParticleLayer);p.mergeOptions(s),p.registerJSONType("ODLineLayer"),t.ODLineLayer=p,Object.defineProperty(t,"__esModule",{value:!0})});